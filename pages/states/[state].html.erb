<!--
  ---
  title: 'Weekly forecast of snow for ski areas in <%= h state %>'
  description: 'Weekly forecast of snow for ski areas in <%= h state %>. <%= state_snow_count(state) %> resorts with snow in the forecast.'
  page_url: '/states/<%= state.to_url %>'
  ---
-->

<div class="text-sm breadcrumbs mb-4">
  <ul>
    <li><a href="/">All</a></li>

    <li>
      <a href="/countries/<%= resorts.first.country_name.to_url %>">
        <%= h resorts.first.country_name %>
      </a>
    </li>

    <li><%= h state %></li>
  </ul>
</div>

<div class="mb-6">
  <div class="flex justify-between items-center mb-2">
    <h2 class="text-3xl font-bold">
      <%= h state %>

      <a
        href="/states/<%= state.to_url %>-snow-now"
        class="link link-primary text-sm whitespace-nowrap"
      >
        Snow Now
      </a>
    </h2>
  </div>
</div>

<!-- Best Days to Ski for Region -->
<% region_days = best_ski_days_for_region(resorts, limit: 7) %>

<div class="mb-8">
  <h3 class="text-xl font-bold mb-3">üéø Best Days to Ski in <%= h state %></h3>

  <p class="text-base-content/70 text-sm mb-4">
    Aggregated across <%= resorts.size %> resorts
  </p>

  <div class="grid grid-cols-2 sm:grid-cols-4 lg:grid-cols-7 gap-2">
    <% region_days.each do |day| %>
      <div class="ski-day-card ski-day-<%= day[:rating].downcase %> p-3 rounded-lg text-center">
        <div class="text-xs font-medium opacity-80"><%= day[:name] %></div>
        <div class="text-2xl font-black my-1"><%= day[:avg_score] %></div>

        <div class="text-xs font-bold uppercase tracking-wide">
          <%= day[:rating] %>
        </div>

        <% if day[:resorts_with_snow] > 0 %>
          <div class="text-xs mt-1">
            ‚ùÑÔ∏è <%= day[:resorts_with_snow] %>
            resort<%= day[:resorts_with_snow] == 1 ? '' : 's' %>
          </div>
        <% end %>
      </div>
    <% end %>
  </div>

  <% best = region_days.max_by { |d| d[:avg_score] } %>

  <% if best && best[:avg_score] >= 60 %>
    <div class="mt-4 p-3 bg-base-200 rounded-lg">
      <span class="font-bold">üí° Best day:</span>
      <span><%= best[:name] %></span>

      <% if best[:resorts_with_snow] > 0 %>
        <span class="text-sm opacity-80">
          (<%= best[:resorts_with_snow] %>
          resort<%= best[:resorts_with_snow] == 1 ? '' : 's' %> with snow
          expected)
        </span>
      <% end %>
    </div>
  <% end %>
</div>

<h3 class="text-xl font-semibold mb-4">Forecast</h3>

<% headers, rows=table_for_resorts(resorts) %>

<div class="overflow-x-auto">
  <table class="table w-full sticky">
    <!-- Table header -->
    <thead>
      <tr>
        <% headers.each do |header| %>
          <th><%= h header %></th>
        <% end %>
      </tr>
    </thead>

    <tbody>
      <% rows.each do |row| %>
        <% has_snow = row.drop(1).any? { |cell| snow?(cell) } %>

        <% if has_snow %>
          <tr>
            <% row.each_with_index do |cell, index| %>
              <% if index == 0 %>
                <!-- First column is the resort name/link -->
                <td class="font-medium"><%= cell %></td>
              <% elsif snow?(cell) %>
                <!-- Highlight cells with snow -->
                <td class="snow-cell">
                  <span class="snow-value"><%= h cell %>‚ùÑÔ∏è</span>
                </td>
              <% else %>
                <!-- Regular cell -->
                <td class="text-gray-400"><%= h cell %></td>
              <% end %>
            <% end %>
          </tr>
        <% else %>
          <tr class="no-snow">
            <% row.each_with_index do |cell, index| %>
              <% if index == 0 %>
                <!-- First column is the resort name/link -->
                <td class="font-medium"><%= cell %></td>
              <% elsif snow?(cell) %>
                <!-- Highlight cells with snow -->
                <td class="snow-cell">
                  <span class="snow-value"><%= h cell %>‚ùÑÔ∏è</span>
                </td>
              <% else %>
                <!-- Regular cell -->
                <td class="text-gray-400"><%= h cell %></td>
              <% end %>
            <% end %>
          </tr>
        <% end %>
      <% end %>
    </tbody>
  </table>
</div>
